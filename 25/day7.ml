let solve_line line idxs =
  Hashtbl.fold
  (fun k v acc ->
    if String.get line k = '^'
    then (
      Hashtbl.remove idxs k;
      Hashtbl.replace idxs (k+1) ();
      Hashtbl.replace idxs (k-1) ();
      acc + 1
    )
    else acc
  ) idxs 0

let solve ls =
  let start = match ls with
  | [] -> failwith "what"
  | h :: _ -> String.index h 'S'
  in
  let idxs = Hashtbl.create 100 in
  Hashtbl.replace idxs start ();
  let rec solve_helper ls acc =
    match ls with
    | [] -> acc
    | h :: t -> solve_helper t (acc + solve_line h idxs)
  
  in
  match ls with
  | [] -> 0
  | _ ::rest -> solve_helper rest 0

let solve2 ls =
  let width = String.length (List.hd lines) in
  let counts = Array.make width 0 in
  let start = String.index (List.hd lines) 'S' in
  counts.(start) <- 1;
  List.iter (fun line ->
    let new_counts = Array.make width 0 in
    for i = 0 to width - 1 do
      if counts.(i) > 0 then
        if String.get line i = '^' then (
          new_counts.(i-1) <- new_counts.(i-1) + counts.(i);
          new_counts.(i+1) <- new_counts.(i+1) + counts.(i)
        ) else (
          new_counts.(i) <- new_counts.(i) + counts.(i)
        )
    done;
    Array.blit new_counts 0 counts 0 width
  ) (List.tl lines);
  Array.fold_left (+) 0 counts

let example = [
".......S.......";
"...............";
".......^.......";
"...............";
"......^.^......";
"...............";
".....^.^.^.....";
"...............";
"....^.^...^....";
"...............";
"...^.^...^.^...";
"...............";
"..^...^.....^..";
"...............";
".^.^.^.^.^...^.";
"..............."
]


let ls =[
"......................................................................S......................................................................";
".............................................................................................................................................";
"......................................................................^......................................................................";
".............................................................................................................................................";
".....................................................................^.^.....................................................................";
".............................................................................................................................................";
"....................................................................^.^.^....................................................................";
".............................................................................................................................................";
"...................................................................^.^...^...................................................................";
".............................................................................................................................................";
"..................................................................^.^.^.^.^..................................................................";
".............................................................................................................................................";
".................................................................^.^.^...^.^.................................................................";
".............................................................................................................................................";
"................................................................^.^.^...^.^.^................................................................";
".............................................................................................................................................";
"...............................................................^...^...^.^.^.^...............................................................";
".............................................................................................................................................";
"..............................................................^.^.^...^...^.^.^..............................................................";
".............................................................................................................................................";
".............................................................^.^.^...^.^...^.^.^.............................................................";
".............................................................................................................................................";
"............................................................^.....^.^.^.^.^.^.^.^............................................................";
".............................................................................................................................................";
"...........................................................^...^.^...^.^...^...^.^...........................................................";
".............................................................................................................................................";
"..........................................................^.^.^.^.^...^...^.^.....^..........................................................";
".............................................................................................................................................";
".........................................................^.^.^...^.^.^...^...^.....^.........................................................";
".............................................................................................................................................";
"........................................................^.^.....^.^.^.^.^.^.^.^.^...^........................................................";
".............................................................................................................................................";
".......................................................^...^.^.^.^.^...^...^.^...^.^.^.......................................................";
".............................................................................................................................................";
"......................................................^.^.^.^...^.......^...^.....^.^.^......................................................";
".............................................................................................................................................";
".....................................................^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.....................................................";
".............................................................................................................................................";
"....................................................^.^.^.....^...^.^.^.^.^.^.^.^.^.^.^.^....................................................";
".............................................................................................................................................";
"...................................................^.^.....^.^.^...^...^.^.^.^...^.......^...................................................";
".............................................................................................................................................";
"..................................................^...^.......^.....^...^.^.^.^.^.^...^...^..................................................";
".............................................................................................................................................";
".................................................^.^.^.....^.^.^.^...^.^...^.^.^.^.^...^.^.^.................................................";
".............................................................................................................................................";
"................................................^.^.^...^.^...^.^.......^...^...^.^.^.^.^.^.^................................................";
".............................................................................................................................................";
"...............................................^.........^...^.^.......^.....^.^.^...^.^.^.^.^...............................................";
".............................................................................................................................................";
"..............................................^.^.^.^.^.^...^.^.....^...^.^.^...^...^.^...^.^.^..............................................";
".............................................................................................................................................";
".............................................^...^.^.^.......^.....^.^.^.^...^.^.....^.^.....^.^.............................................";
".............................................................................................................................................";
"............................................^...^...^.^.^...^...^.^.^...^...^.....^.^.^.^.^.^.^.^............................................";
".............................................................................................................................................";
"...........................................^.....^...^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^.^...........................................";
".............................................................................................................................................";
"..........................................^.^.^...^...^.^.....^...^.......^.^...^.^.^.^...^.^...^.^..........................................";
".............................................................................................................................................";
".........................................^.^.^...^...^.^.^.^...^.^...^.^.^.^...^.....^.^.^.^.^...^.^.........................................";
".............................................................................................................................................";
"........................................^.^.^...^...^.^.^.^.....^.^.......^.....^...^.^.^.^.^.....^.^........................................";
".............................................................................................................................................";
".......................................^.^.^...^.^.^...^.^.^.^.^.^...^.^...^.^.^.........^.^.^.....^.^.......................................";
".............................................................................................................................................";
"......................................^.^.^...^.....^.^.^.^.....^...^.......^.^.....^.^.^...^...^...^.^......................................";
".............................................................................................................................................";
".....................................^.^.^.^...^.....^.....^.^.^.^.....^.^.^.....^.^...............^...^.....................................";
".............................................................................................................................................";
"....................................^.^.^.^.....^.^.^...^...^.....^.^.^.^.^.^.^.^.^.^...^.^.^...^.^.^.^.^....................................";
".............................................................................................................................................";
"...................................^...^.^...^.....^.^...^...^.^.^.^...^...^.....^.....^.^...^.^.^...^.^.^...................................";
".............................................................................................................................................";
"..................................^.^.^.^.......^...^.^.^.^...^.....^.^...^.^.^...^.^.^.^.^.^.^...^.^...^.^..................................";
".............................................................................................................................................";
".................................^.....^.^.^.....^.....^.^.^.^.^.^...^.........^.^.^.^.^.....^...^.^.^.^...^.................................";
".............................................................................................................................................";
"................................^.^.^.^.^.^.^.^...^.^.......^.^.....^.^.^.^...^...^.^.^.......^...^.......^.^................................";
".............................................................................................................................................";
"...............................^.^...^.^...^...^.^.^.^.^...^.^...^.^...^...^...^...^.^.^.^.^.^...^...^.^...^.^...............................";
".............................................................................................................................................";
"..............................^.^...^.^...^...^...^.^.^.^...^...^.^.....^.^...^.^.^...^.^.^.^...^.^.^.^.^.^.^.^..............................";
".............................................................................................................................................";
".............................^.^.........^.^.^.....^.^.^...^.^.^.^.^.^.^...^...^.^...^...^.^.....^.^.^.^.^.^.^.^.............................";
".............................................................................................................................................";
"............................^.^.^...^...^.^.....^.......^...^.^...^...^.^.....^...^.^.....^.^.^...^.^.^.^.^.....^............................";
".............................................................................................................................................";
"...........................^.^.^...^.^...^.^.^...^.^.^.^.^...^.^.^...^.^.^.^.....^...^...^.^...^...^.^.^...^.^.^.^...........................";
".............................................................................................................................................";
"..........................^...^.......^.^.^.^.^.....^.^.....^.^.^.^.^.^...^.^.......^.^...^.^.^...^...^...^.^.^...^..........................";
".............................................................................................................................................";
".........................^.^.^.^.^...^...^.^.^.^...^.^...^...^...^.^.^.^.^.^.....^...^.^.^.^.^.^.^.....^.^.^.^.....^.........................";
".............................................................................................................................................";
"........................^.^...^.^.^.^.^.^.....^.^.^.^.^...^.^.^...^.^.....^.^.....^...^.....^.^.^.^.^.^.^.^.^.....^.^........................";
".............................................................................................................................................";
".......................^.^.^.^.....^.^.....^.^...^.^...........^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.......................";
".............................................................................................................................................";
"......................^.^.^...^.^...^.^.^.^.^.^.........^.....^.^.....^.^.^.^...^...^...^.^.^.^.^.^.^...^.^.......^.^.^......................";
".............................................................................................................................................";
".....................^.^.^...^.^...^...^.....^.^.^...^.^.^...^.^...^...^...^.^.^.^.^...^.^...^.^.^...^...^.^.^.^.^.....^.....................";
".............................................................................................................................................";
"....................^.^.....^.....^.^.^.^.^.^.^.^.^.^...^...^.^.....^.^.^.^...^...^...^.^.^.^.^...^.^.....^.^...^...^.^.^....................";
".............................................................................................................................................";
"...................^.^...^...^...^.^.........^...^.^...^...^.^.^.^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^...^...^.^.^.^...^.^...................";
".............................................................................................................................................";
"..................^.^.....^.^.^.....^...^.^.^.^.^.^...^.^.....^.^...^...^.^.^...^.^...^.^.^.^.^...^...^.^...^.^.^.^.^...^.^..................";
".............................................................................................................................................";
".................^...^.^...^.^.^...^.....^.^.^.^...^...^...^.^...^.^.^.^.^.^.^.^...^.^.^.^.^.....^...^.^...^...^.^...^.^...^.................";
".............................................................................................................................................";
"................^.......^.^.^...^.^.....^.^.....^...^...^.........^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^...^.^...^...^.^.^.^.^................";
".............................................................................................................................................";
"...............^.^.^.^...^.^...^.^.^.^.......^.^.....^.^.^.^.^.^.^.^.^.....^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^...^...^.^...............";
".............................................................................................................................................";
"..............^.^.....^...^...^...^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.....^.^.^...^.....^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^..............";
".............................................................................................................................................";
".............^.^.^.^.^.^.....^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.....^...^.^.......^...^.^.^.^.....^.^.^.^.^.^.^.....^.^.^.^.............";
".............................................................................................................................................";
"............^...^...^.^.^.......^.^.^...^...^...^.^.^.^...^.^.^.^.....^...^...^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.....^.^...^.^.^............";
".............................................................................................................................................";
"...........^.^.......^.^.^.^.......^.^.^...^...^.^.^.^.^.^.^.^.^.......^.^.^.^.^.^.....^.^...^.^.^.....^.^.^.^...^.^...^.^.^...^.^...........";
".............................................................................................................................................";
"..........^.^...^...^.....^.^.......^.^.^.^.^.^.^.^.^.^...^.^.^.^.....^...^.^.....^.^.^...^.^.....^.......^...^.^.^...^.^.^.^.^.^.^..........";
".............................................................................................................................................";
".........^...^.^.^.^.......^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.......^.^.^...^.^...^.^...^.....^...^.^.^...^.....^.^...^.^.^.^.........";
".............................................................................................................................................";
"........^.^.......^.^.^.^.^.^...^.....^...^.......^.^.^.^...^.^...^.....^.....^.^.....^.^.^.......^.^.^.^.^.....^...^.^...^.^.^.^.^.^........";
".............................................................................................................................................";
".......^.^.^.^.......^.^.^...^.^.^.^.^.^...^.^.^...^.^.^.^...^.^.^.^.^.^...^.^...........^.^...^.^...^.^.....^.^.^.......^.^.^...^.^.^.......";
".............................................................................................................................................";
"......^.^...^.^...^.^.^.^.....^...^.^...^.....^.^...^.^.^.....^.^.^.........^.....^.^.....^.^.^.^.^.^...^.^.^...^...^.....^.^.^.^.^.^.^......";
".............................................................................................................................................";
".....^.^.....^.^.^.^.^.^.^...^.^...^...^...^.^.^.....^.^...^.....^...^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.....^.^.^.^.....^.^...^.^.^...^.....";
".............................................................................................................................................";
"....^.^...^.^...^.^.^.^.^.^.^.^.....^...^.......^.^.^.^.^...^.......^.^.^.^.......^.............^.^.^.^.^.^.^...^.^.^.^.....^.^.^.^.....^....";
".............................................................................................................................................";
"...^.^.^.^.^.^.^.^.^.^.^.^...^...^.^...^...^.^.^.^...^.^.^.^.^.^.^...^.^.^...^.....^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.....^.^...^.....^.^...";
".............................................................................................................................................";
"..^...^.^.^.^.^...^.^.^.^...^...^...^.^.....^...^.....^.^.....^.^.^...^.^.^...^.^...^...^...^.^.^...^.^...^.^.....^.^...^.^.....^...^...^.^..";
".............................................................................................................................................";
".^.^.......^...^.^...^.^...^.^...^.^.^.^.^.........^.^.......^.^.^.......^.^.^.^.^.^...^.^...^.^.......^.....^.^.^.^.^.^.^.^...^...^.^...^.^.";
"............................................................................................................................................."
]
